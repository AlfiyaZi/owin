<html>
<head>
    <title>OWIN &mdash; Open Web Server Interface for .NET, v1.0 Draft 3</title>
    <style>
    body
    {
        font-family: Helvetica, sans-serif;
    }
    </style>
</head>
<body>

<h1>OWIN &mdash; Open Web Server Interface for .NET, v1.0 Draft 4</h1>
<ul>
    <li>Author: <a href="http://bvanderveen.com">Benjamin van der Veen</a></li>
    <li>Last updated: 13 February 2011</li>
    <li>Discussion: <a href="http://groups.google.com/group/net-http-abstractions">.NET HTTP Abstractions</a></li>
</ul>

<h2>Contents</h2>
<ul>
	<li><a href="#Overview">Overview</a></li>
	<li><a href="#Definition">Definition</a>
		<ul>
			<li><a href="#ApplicationDelegate">Application Delegate</a></li>
			<li><a href="#EntityStreamDelegate">Entity Stream Delegate</a></li>
			<li><a href="#EnvironmentDictionary">Environment Dictionary</a></li>
			<li><a href="#ResponseCallback">Response Callback</a></li>
		</ul>
	</li>
	<li><a href="#Paths">Paths</a></li>
	<li><a href="#ErrorHandling">Error Handling</a>
		<ul>
			<li><a href="#ApplicationErrors">Application Errors</a></li>
			<li><a href="#HostErrors">Host Errors</a></li>
		</ul>
	</li>
	<li><a href="#Acknowledgements">Acknowledgements</a></li>
</ul>

<a name="Overview"></a>
<h2>Overview</h2>

<p>This document defines a standard interface between .NET web servers and web applications. The goal of the OWIN interface is to decouple server and application, encourage the development of simple "middleware" modules for .NET web development, and, by being an open standard, stimulate the open source ecosystem of .NET web development tools.</p>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED",  "MAY", and "OPTIONAL" in this document are to be interpreted as described in RFC 2119.</p>

<a name="Definition"></a>
<h2>Definition</h2>

<p>In this document, an OWIN-compatible web server is referred to as a "host", and an instance of an application delegate (described below) is referred to as an "application". Broadly speaking, a host invokes an application (providing as arguments an environment dictionary, and response and error callbacks); an application either provides a response to the host by invoking the response callback with response information, or indicates an error by invoking the error callback with an exception.</p>
	
<p>How an application is provided to a host is outside the scope of this specification and must be documented by the host implementor.</p>

<p>Because OWIN is defined in terms of a raw delegate, there is no need for an assembly called "OWIN.dll" or similar. Implementing either the host or application side the OWIN spec does not introduce a dependency to a project.</p>

<p>In this document, the C# <code>Action</code>/<code>Func</code> syntax is used to notate the delegate structure. However, the delegate structure could be equivalently represented with F# native functions, CLR interfaces, or named delegates. This is by design; when implementing OWIN, choose an equivalent representation that works for you.</p>

<a name="ApplicationDelegate"></a>
<h3>Application Delegate</h3>

<p>The primary interface in OWIN is called the <em>application delegate</em>. An application delegate takes three parameters: an environment dictionary, a response callback, and an error callback.</p>

<pre><code>Action&lt;
    // an environment dictionary containing host and request data
    IDictionary&lt;string, object&gt;, 
    
    // response callback
    Action&lt;
		string, // response status, e.g., "200 OK"
		IDictionary&lt;string, string&gt;, // response headers
		EntityStream // response body, as represented by an entity stream delegate (described below)
	&gt;, 
    
    // error callback
    Action&lt;Exception&gt;
&gt;</code></pre>

<p>A host must provide non-null values for all three arguments. The application must invoke either the response callback or the error callback exactly once, or throw an exception. The response and error callbacks provided to an application by a host must not throw an exception.</p>

<a name="EntityStreamDelegate"></a>
<h3>Entity Stream Delegate</h3>

<p>The <em>entity stream delegate</em> is a mechanism for transferring streaming data between host and application. It is used for both request and response entities in OWIN.</p>

<p>The entity stream delegate is roughly equivalent to <code>IObserver</code>/<code>IObservable</code>, but with a modified "on next" signature. An instance of the delegate is a producer; a consumer invokes the delegate and provides it "on next", "on error", and "on complete" callbacks. The return value of the entity stream delegate is a cancellation delegate, which allows the consumer to instruct the producer not to produce any further values.</p>

<p>The purpose of the modified "on next" callback is to enable the consumer to instruct the producer to "back off" and not produce values for a time, thereby preventing potentially unbounded buffer sizes in host and application implementations.</p>

<p>In addition to taking a data value parameter, the "on next" callback takes a continuation parameter, and returns a boolean value indicating whether or not it will invoke the continuation.</p>

<pre><code>Func&lt;
	
	// on next
	Func&lt;
		ArraySegment&lt;byte&gt;, // data
		Action, // continuation
		bool // will invoke continuation
	&gt;,
 	
	// on error
	Action&lt;Exception&gt;,
	
	// on complete
	Action,
	
	// cancel 
	Action 
&gt;</code></pre>

<p>If the producer provides a null continuation, the consumer must return false. If the producer provides a non-null continuation, the consumer may return true or false. If the consumer returns true, the consumer must eventually invoke the continuation. The consumer must not invoke the continuation in a manner such that the "on next" callback which provided the continuation is on the stack when the continuation is invoked. If the consumer returns false, it must not invoke the continuation provided by the producer.

<p>If the consumer returns true, the producer must not invoke the consumer "on next", "on error", or "on complete" callbacks until the consumer invokes the continuation provided by the producer. If the consumer returns false, the producer may invoke the "on next", "on error, or "on complete"" callbacks at any time.</p>

<p>Instances of <code>ArraySegment&lt;byte&gt;</code> provided to consumers must be considered internal to the producer implementation and must be guaranteed to be valid only for the duration of the "on next" callback. Once the "on next" callback returns, the <code>ArraySegment&lt;byte&gt;</code> may be invalid. If a consumer wishes to retain the data it must copy it out of the buffer before the "on next" callback returns.</p>

<a name="EnvironmentDictionary"></a>
<h3>Environment Dictionary</h3>

<p>When a host invokes an application delegate, it provides the application with an environment dictionary. The environment dictionary represents the request the application is to process and provides additional context to the application. An environment dictionary must be mutable and must contain the following keys whose values must be non-null unless otherwise specified:</p>

<table border=1>
<tr>
    <td><code>owin.RequestMethod</code></td>
    <td>The HTTP request method string of the request (e.g., <code>"GET"</code>, <code>"POST"</code>).</td>
</tr>

<tr>
    <td><code>owin.RequestUri</code></td>
    <td>The HTTP request URI string of the request. The value includes the query string of the HTTP request URI (e.g., <code>"/path/and?query=string"</code>). The URI must be relative to the application delegate; see <a href="#Paths">Paths</a>.</td>
</tr>
    <tr>
        <td>
            <code>owin.RequestHeaders</code>
        </td>
        <td>
            <p>A dictionary of the form <code>IDictionary&lt;string, string&gt;</code> which represents the HTTP headers present in the request (the <em>request header dictionary</em>).</p>
            <p>The dictionary must be mutable and its keys must be case-insensitive. Keys must be HTTP header names without <code>':'</code> or whitespace. </p>
            <p>The requirements below are predicated on <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec4.html#sec4.2">RFC 2616 section 4.2</a>.</p>
            <p>Values must be <code>string</code> objects containing the corresponding field-value strings, with any linear whitespace (as defined by <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec2.html#sec2.2">RFC 2616 section 2.2</a>) collapsed to a single space (<code>' '</code>). If a given field-name appears multiple times in a request received by a host, the host must collapse the corresponding field-values into a single string, with the field-values delimited by a comma (<code>','</code>), preserving the order in which the values appeared in the original request. Hosts must not generate request header dictionaries whose values start or end with a comma, contain adjacent commas, or are null, empty, or consist entirely of linear whitespace.</p>
        </td>
    </tr>
    <tr>
        <td>
            <code>owin.RequestBody</code>
        </td>
        <td>
			<p>An entity stream delegate representing the body of the request.</p>
        </td>
    </tr>
    <tr>
        <td>
            <code>owin.BaseUri</code>
        </td>
        <td>
            The portion of the request URI's path corresponding to the "root" of the application object. See <a href="#Paths">Paths</a>.
        </td>
    </tr>
    <tr>
        <td>
            <code>owin.ServerName</code>, <code>owin.ServerPort</code>
        </td>
        <td>
            Hosts should provide values which can be used to reconstruct the full URI of the request in absence of the HTTP <code>Host</code> header of the request.
        </td>
    </tr>
    <tr>
        <td>
            <code>owin.UriScheme</code>
        </td>
        <td>
            <code>"http"</code> or <code>"https"</code>.
        </td>
    </tr>
    <tr>
        <td>
            <code>owin.RemoteEndPoint</code>
        </td>
        <td>
            A <code>System.Net.IPEndPoint</code> representing the connected client.
        </td>
    </tr>
     <tr>
        <td>
            <code>owin.Version</code>
        </td>
        <td>
            The string <code>"1.0"</code> indicating OWIN version 1.0.
        </td>
    </tr>
    
</table>

<p>In addition to these keys, the host, application, or user may add arbitrary data associated with the request to the environment dictionary.</p>

<a name="ResponseCallback"></a>
<h3>Response Callback</h3>

<p>The response callback of the application delegate takes three arguments. The first two are of type <code>string</code>, <code>Dictionary&lt;string, string&gt;</code>. The third is an entity stream delegate representing the response body. These arguments together represent an HTTP response generated by an application.</p>

<p>The first argument to the response callback must be a string which contains the integer status of the response followed by a space and a reason phrase without a newline (e.g., <code>"200 OK"</code>). All characters in the status string provided by an application should be within the ASCII codepage.</p>

<p>The second argument to the response callback must be a dictionary representing the headers to be sent with the request (the <em>response header dictionary</em>). The dictionary must be mutable and its keys must be case-insensitive. The keys must be header field-names without <code>':'</code> or whitespace. Values must be <code>string</code> objects containing the corresponding header field-value strings. The application must encode or strip all <code>'\r'</code> and <code>'\n'</code> characters from header value data. The application must use the token <code>"\r\n"</code> to delimit values that are required to be sent as separate response headers of the same name (this is to support <code>Set-Cookie</code>). Applications must not generate response header dictionaries whose values start or end with <code>"\r\n"</code>, contain adjacent <code>"\r\n"</code> delimiters, or are null, empty, or consist entirely of linear whitespace (as defined by <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec2.html#sec2.2">RFC 2616 section 2.2</a>). All characters in header field-name and field-value strings should be within the ASCII codepage.</p>

<p>The third argument must be an entity stream delegate representing the response body, or null.</p>

<a name="Paths"></a>
<h2>Paths</h2>

<p>Hosts may have the ability to map application objects to some base path. For example, a host might have an application delegate configured to respond to requests beginning with <code>"/my-app"</code>, in which case it must set the value of <code>"owin.BaseUri"</code> in the environment dictionary to <code>"/my-app"</code>. If this host receives a request for <code>"/my-app/foo"</code>, the <code>owin.RequestUri</code> value of the environment dictionary provided to the application configured to respond at <code>"/my-app"</code> must be <code>"/foo"</code>. The value of <code>"owin.BaseUri"</code> may be an empty string and must not end with a trailing slash; the value of the <code>"owin.RequestUri"</code> property must not be an empty string and must start with a slash.</p>

<a name="ErrorHandling"></a>
<h2>Error Handling</h2>

<a name="ApplicationErrors"></a>
<h3>Application Errors</h3>

<p>An application might generate an exception in the following places:</p>

<ul>
    <li>Thrown from an invocation of the application delegate.</li>
    <li>Provided to the error callback of the application delegate.</li>
    <li>Thrown from the result callback of the request body delegate.</li>
    <li>Thrown from the error callback of the request body delegate.</li>
    <li>Thrown from the <code>GetEnumerator</code> method of the response enumerable.</li>
    <li>Thrown from the <code>MoveNext</code> method of the enumerator returned by the response enumerable.</li>
    <li>Thrown from the <code>Current</code> property of the enumerator returned by the response enumerable.</li>
    <li>Thrown from an invocation of an asynchronous response item contained in the response enumerable.</li> 
    <li>Provided to the error callback of an asynchronous item delegate contained in the response enumerable.</li>
</ul>

<p>An application should attempt to trap its own internal errors and generate an appropriate (possibly 500-level) response rather than propagating an exception up to the host.</p> 

<p>After an application provides a response, if the response enumerable is non-null, the host should attempt to enumerate at least one item from the response enumerable before writing the response headers to the underlying transport. If the enumeration of the first item results in an error, the host will be able to generate a 500-level response. Otherwise, the application has caught as many of its internal errors as possible and host can begin the response without further buffering. If an exception is thrown by the application while enumerating subsequent items from the response body enumerable, the host may write a textual description of the error to the underlying transport, and/or close the connection.</p>

<a name="HostErrors"></a>
<h3>Host Errors</h3>

<p>A host might generate exceptions in the following places:</p>

<ul>
    <li>Thrown from an invocation of the request body delegate.</li>
    <li>Provided to the error callback of the request body delegate.</li>  
</ul>

<p>An exception generated in either of these places may indicate that the client has closed or dropped the connection, or another transport-layer error has occurred. The application should perform any post-mortem logic it needs to, and must propagate the exception back to the host through one of the sites described in <a href="#ApplicationErrors">Application Errors</a>.</p>

<a name="Acknowledgements"></a>
<h2>Acknowledgments</h2>

<p>This specification draws heavily on the wonderful <a href="http://www.python.org/dev/peps/pep-0333/">PEP 333 (WSGI)</a>. Many thanks to everyone participating in the discussion at <a href="http://groups.google.com/group/net-http-abstractions">.NET HTTP Abstractions</a>, and in particular:
	<ul>
		<li><a href="http://twitter.com/panesofglass">Ryan Riley</a></li>
		<li><a href="http://twitter.com/serialseb">Sebastien Lambla</a></li>
		<li><a href="http://jdhardy.blogspot.com/">Jeff Hardy</a></li>
		<li><a href="http://twitter.com/demisbellot">Demis Bellot</a></li>
		<li><a href="http://whereslou.com/">Louis DeJardin</a></li>
	</ul>
</body>
</html>
